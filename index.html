<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>極速記帳 APP (黑灰白版)</title>
    <!-- 載入 Tailwind CSS (響應式設計) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 React 和 Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* 確保 body 和主要的 div 佔滿整個 viewport */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f9fafb;
        }
        #root {
            min-height: 100vh;
        }
        /* 為了讓動畫更流暢，添加簡單的淡入效果 */
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 匯入的圖示 (Lucide Icons) ---
        const { PlusCircle, Download, Trash2, PieChart, List, DollarSign, Utensils, Shirt, Home, Car, BookOpen, Smile, TrendingUp, CreditCard, Wallet, Smartphone } = lucide;

        // --- 主應用程式元件 ---
        function App() {
            // 由於 HTML 環境無法直接使用 Lucide React Components，這裡我們使用內嵌 SVG 或簡化處理
            // 不過我們使用 @babel/standalone，可以直接使用 React components，所以我們使用 `lucide` 全域變數

            const STORAGE_KEY = 'mifa_expenses_v2';

            const [expenses, setExpenses] = React.useState(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                return saved ? JSON.parse(saved) : [];
            });

            const [amount, setAmount] = React.useState('');
            const [note, setNote] = React.useState('');
            const [category, setCategory] = React.useState('食');
            const [paymentMethod, setPaymentMethod] = React.useState('現金');
            const [view, setView] = React.useState('add'); // 'add', 'stats', 'list'

            React.useEffect(() => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(expenses));
            }, [expenses]);

            const categories = [
                { id: '食', name: '食', icon: <Utensils size={20} /> },
                { id: '衣', name: '衣', icon: <Shirt size={20} /> },
                { id: '住', name: '住', icon: <Home size={20} /> },
                { id: '行', name: '行', icon: <Car size={20} /> },
                { id: '育', name: '育', icon: <BookOpen size={20} /> },
                { id: '樂', name: '樂', icon: <Smile size={20} /> },
            ];

            const paymentMethods = [
                { id: '現金', name: '現金', icon: <Wallet size={18} /> },
                { id: '信用卡', name: '信用卡', icon: <CreditCard size={18} /> },
                { id: '行動支付', name: '行動支付', icon: <Smartphone size={18} /> },
            ];

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!amount || isNaN(parseFloat(amount)) || parseFloat(amount) <= 0) return;

                const newExpense = {
                    id: Date.now(),
                    date: new Date().toISOString().split('T')[0], // YYYY-MM-DD
                    fullDate: new Date().toLocaleString('zh-TW'),
                    amount: parseFloat(amount),
                    category,
                    paymentMethod,
                    note: note || '無備註'
                };

                setExpenses([newExpense, ...expenses]);
                setAmount('');
                setNote('');
                setPaymentMethod('現金');
            };

            const deleteExpense = (id) => {
                if (window.confirm('確定要刪除這筆紀錄嗎？')) {
                    setExpenses(expenses.filter(exp => exp.id !== id));
                }
            };

            const exportToCSV = () => {
                const BOM = "\uFEFF";
                const headers = "日期,分類,支付方式,金額,備註\n";
                const csvContent = expenses.map(e => `${e.date},${e.category},${e.paymentMethod},${e.amount},${e.note}`).join("\n");
                const blob = new Blob([BOM + headers + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', `Mifa_記帳資料_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // Statistics Calculation
            const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
            const monthExpenses = expenses.filter(e => e.date.startsWith(currentMonth));
            const totalAmount = monthExpenses.reduce((acc, curr) => acc + curr.amount, 0);

            const categoryStats = categories.map(cat => {
                const sum = monthExpenses
                    .filter(e => e.category === cat.id)
                    .reduce((acc, curr) => acc + curr.amount, 0);
                return { ...cat, sum, percentage: totalAmount === 0 ? 0 : Math.round((sum / totalAmount) * 100) };
            }).sort((a, b) => b.sum - a.sum);

            const getGrayScaleColor = (index, total) => {
                const intensity = Math.round(240 - (index / total) * 180); 
                return `rgb(${intensity}, ${intensity}, ${intensity})`;
            };

            return (
                <div className="min-h-screen bg-white text-gray-900 font-sans pb-24 relative">
                    {/* Header */}
                    <div className="bg-white sticky top-0 z-10 border-b border-gray-200">
                        <div className="max-w-md mx-auto px-4 py-4 flex justify-between items-center">
                            <h1 className="text-lg font-bold flex items-center gap-2">
                                <div className="bg-black text-white p-1 rounded-full"><DollarSign size={16} /></div> Mifa 的記帳本
                            </h1>
                            <button 
                                onClick={exportToCSV}
                                className="text-xs flex items-center gap-1 bg-gray-100 text-gray-600 px-3 py-1.5 rounded-full hover:bg-gray-200 transition"
                            >
                                <Download size={14} /> 匯出
                            </button>
                        </div>
                    </div>

                    <div className="max-w-md mx-auto p-4 space-y-6">
                        
                        {/* VIEW: ADD EXPENSE */}
                        {view === 'add' && (
                            <div className="animate-fade-in">
                                <div className="bg-white p-1 rounded-2xl">
                                    <form onSubmit={handleSubmit} className="space-y-6">
                                        
                                        {/* Amount Input */}
                                        <div className="relative">
                                            <span className="absolute left-4 top-1/2 -translate-y-1/2 text-2xl text-gray-400">$</span>
                                            <input
                                                type="number"
                                                inputMode="decimal"
                                                value={amount}
                                                onChange={(e) => setAmount(e.target.value)}
                                                placeholder="0"
                                                className="w-full text-center text-5xl font-bold text-gray-900 py-6 border-b-2 border-gray-200 focus:border-black focus:outline-none placeholder-gray-200 bg-transparent transition-colors"
                                                autoFocus
                                            />
                                        </div>

                                        {/* Categories Grid */}
                                        <div className="grid grid-cols-3 gap-3">
                                            {categories.map((cat) => (
                                                <button
                                                    key={cat.id}
                                                    type="button"
                                                    onClick={() => setCategory(cat.id)}
                                                    className={`flex flex-col items-center justify-center p-3 rounded-2xl border-2 transition-all duration-200 ${
                                                        category === cat.id 
                                                          ? 'bg-black text-white border-black shadow-md scale-105' 
                                                          : 'bg-gray-50 text-gray-500 border-gray-200 hover:bg-gray-100'
                                                    }`}
                                                >
                                                    <div className="mb-1">{cat.icon}</div>
                                                    <span className="text-sm font-medium">{cat.name}</span>
                                                </button>
                                            ))}
                                        </div>

                                        {/* Payment Method Selection */}
                                        <div>
                                            <label className="block text-sm font-medium text-gray-600 mb-2 pl-1">支付方式</label>
                                            <div className="flex gap-2">
                                                {paymentMethods.map((method) => (
                                                    <button
                                                        key={method.id}
                                                        type="button"
                                                        onClick={() => setPaymentMethod(method.id)}
                                                        className={`flex-1 flex items-center justify-center gap-2 py-3 rounded-xl text-sm font-medium border transition-all duration-200 ${
                                                            paymentMethod === method.id
                                                                ? 'bg-black text-white border-black shadow-sm'
                                                                : 'bg-white text-gray-500 border-gray-200 hover:bg-gray-50'
                                                        }`}
                                                    >
                                                        {method.icon}
                                                        {method.name}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>

                                        {/* Note Input */}
                                        <input
                                            type="text"
                                            value={note}
                                            onChange={(e) => setNote(e.target.value)}
                                            placeholder="備註 (例如: 午餐、捷運...)"
                                            className="w-full bg-gray-50 px-4 py-4 rounded-xl border border-gray-200 focus:border-black focus:outline-none transition-colors text-gray-700"
                                        />

                                        {/* Submit Button */}
                                        <button
                                            type="submit"
                                            disabled={!amount}
                                            className="w-full bg-black hover:bg-gray-800 text-white font-bold py-4 rounded-xl shadow-md disabled:opacity-50 disabled:cursor-not-allowed transform active:scale-95 transition-all flex items-center justify-center gap-2 text-lg"
                                        >
                                            <PlusCircle /> 儲存紀錄
                                        </button>
                                    </form>
                                </div>

                                {/* Recent 3 Items Preview */}
                                <div className="mt-8">
                                    <h3 className="text-sm font-bold text-gray-400 mb-3 pl-1 tracking-wider uppercase">最近紀錄</h3>
                                    <div className="space-y-3">
                                        {expenses.slice(0, 3).map(expense => (
                                            <div key={expense.id} className="bg-white p-3 rounded-xl flex justify-between items-center border border-gray-100 shadow-sm">
                                                <div className="flex items-center gap-3">
                                                    <span className="w-10 h-10 rounded-full flex items-center justify-center text-sm bg-gray-900 text-white">
                                                      {expense.category}
                                                    </span>
                                                    <div>
                                                      <div className="text-base font-medium text-gray-800">{expense.note}</div>
                                                      <div className="text-xs text-gray-400 flex items-center gap-1">
                                                        {expense.date} · {expense.paymentMethod}
                                                      </div>
                                                    </div>
                                                </div>
                                                <span className="font-bold text-gray-900 text-lg">- ${expense.amount}</span>
                                            </div>
                                        ))}
                                        {expenses.length === 0 && <div className="text-center text-gray-400 py-6 text-sm bg-gray-50 rounded-xl border border-dashed border-gray-200">還沒有紀錄</div>}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* VIEW: STATS DASHBOARD */}
                        {view === 'stats' && (
                            <div className="animate-fade-in space-y-6">
                                {/* Total Card */}
                                <div className="bg-black text-white p-6 rounded-3xl shadow-xl">
                                    <div className="text-gray-400 text-sm mb-1 font-medium">{new Date().getMonth() + 1} 月總支出</div>
                                    <div className="text-5xl font-bold tracking-tight">${totalAmount.toLocaleString()}</div>
                                </div>

                                {/* Category Breakdown */}
                                <div className="bg-white rounded-3xl p-6 shadow-sm border border-gray-100">
                                    <h3 className="font-bold text-gray-800 mb-6 flex items-center gap-2 text-lg">
                                        <PieChart size={20} className="text-black"/> 消費分析
                                    </h3>
                                    <div className="space-y-5">
                                        {categoryStats.filter(c => c.sum > 0).map((cat, index) => (
                                            <div key={cat.id}>
                                                <div className="flex justify-between text-sm mb-2 items-center">
                                                    <span className="flex items-center gap-2 font-medium text-gray-700">
                                                        {cat.icon} {cat.name}
                                                    </span>
                                                    <span className="font-bold text-gray-900">${cat.sum.toLocaleString()} <span className="text-gray-400 font-normal">({cat.percentage}%)</span></span>
                                                </div>
                                                <div className="w-full bg-gray-100 rounded-full h-3">
                                                    <div 
                                                        className="h-3 rounded-full transition-all duration-500 ease-out" 
                                                        style={{ width: `${cat.percentage}%`, backgroundColor: getGrayScaleColor(index, categoryStats.length) }}
                                                    ></div>
                                                </div>
                                            </div>
                                        ))}
                                        {totalAmount === 0 && <div className="text-center text-gray-400 py-10 bg-gray-50 rounded-2xl border border-dashed border-gray-200">本月尚無支出數據</div>}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* VIEW: FULL LIST */}
                        {view === 'list' && (
                            <div className="animate-fade-in">
                                <h2 className="text-lg font-bold mb-6 text-gray-800 pl-1">所有紀錄 ({expenses.length})</h2>
                                <div className="space-y-3 pb-20">
                                    {expenses.map((expense) => (
                                        <div key={expense.id} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center group transition-all hover:shadow-md">
                                            <div className="flex items-center gap-4">
                                                <div className="w-12 h-12 rounded-full flex items-center justify-center text-xl bg-gray-900 text-white">
                                                    {categories.find(c => c.id === expense.category)?.icon}
                                                </div>
                                                <div>
                                                    <div className="font-bold text-lg text-gray-900">{expense.note}</div>
                                                    <div className="text-sm text-gray-500 flex items-center gap-1 mt-0.5">
                                                        {expense.date} · {expense.category} · {expense.paymentMethod}
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-4">
                                                <span className="font-bold text-gray-900 text-xl">-${expense.amount}</span>
                                                <button 
                                                    onClick={() => deleteExpense(expense.id)}
                                                    className="text-gray-300 hover:text-red-500 p-2 opacity-0 group-hover:opacity-100 transition-all"
                                                >
                                                    <Trash2 size={20} />
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                    {expenses.length === 0 && (
                                        <div className="text-center py-16 bg-gray-50 rounded-3xl border-2 border-dashed border-gray-200">
                                            <Wallet size={48} className="mx-auto text-gray-300 mb-4" />
                                            <p className="text-gray-500 font-medium">目前還是空的，開始記帳吧！</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Bottom Navigation */}
                    <div className="fixed bottom-4 left-4 right-4 bg-black rounded-full shadow-2xl p-2 z-20 max-w-md mx-auto">
                        <div className="flex justify-between items-center px-4">
                            <button 
                                onClick={() => setView('add')}
                                className={`flex items-center justify-center w-12 h-12 rounded-full transition-all ${view === 'add' ? 'bg-white text-black' : 'text-gray-400 hover:text-white'}`}
                            >
                                <PlusCircle size={24} />
                            </button>
                            
                            <button 
                                onClick={() => setView('stats')}
                                className={`flex items-center justify-center w-12 h-12 rounded-full transition-all ${view === 'stats' ? 'bg-white text-black' : 'text-gray-400 hover:text-white'}`}
                            >
                                <TrendingUp size={24} />
                            </button>

                            <button 
                                onClick={() => setView('list')}
                                className={`flex items-center justify-center w-12 h-12 rounded-full transition-all ${view === 'list' ? 'bg-white text-black' : 'text-gray-400 hover:text-white'}`}
                            >
                                <List size={24} />
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- 啟動 React 應用程式 ---
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
    <!-- 為了讓 Lucide Icons 在 Babel 環境下可用，我們需要這個 CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
</body>
</html>

